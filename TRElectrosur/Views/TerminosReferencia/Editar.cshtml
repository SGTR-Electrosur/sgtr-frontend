@model TRElectrosur.Models.TDREditViewModel
@{
    ViewData["Title"] = "Editar Término de Referencia";

    // Deserializar los datos JSON en la vista
    var fieldsData = System.Text.Json.JsonDocument.Parse(Model.RawFieldsData);
    var version = fieldsData.RootElement.GetProperty("version");
    var fields = fieldsData.RootElement.GetProperty("fields");

    // Estado actual del TDR
    var esAprobado = Model.TDR.CurrentStateID == 5;

    // Información de permisos
    bool isAdmin = ViewBag.IsAdmin ?? false;
    bool canEdit = ViewBag.CanEdit ?? false;

    // Lista de campos por categoría
    var infoGeneralFields = new List<string> { "organoUnidadOrganica", "actividadPoiAccionEstrategica", "denominacionContratacion", "finalidadPublica", "objetivoContratacion" };
    var alcancesFields = new List<string> { "alcancesServicio", "reglamentos", "seguros", "prestacionesAccesorias" };
    var requisitosFields = new List<string> { "requisitosProveedor", "experienciaProveedor", "perfilPersonal", "formacionAcademica", "experienciaPersonalClave", "capacitacion", "otros" };
    var plazosFields = new List<string> { "lugar", "plazo", "entregables", "plazoLugar", "conformidad" };
    var condicionesFields = new List<string> { "sistemaContratacion", "formaCondicionesPago", "responsabilidad", "otrasPenalidades", "medidasSeguridad", "clausula", "anexos" };
}

<div class="container-fluid px-0">
    <!-- Cabecera de la página -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">@(esAprobado ? "Visualizar" : "Editar") Término de Referencia</h1>
            <p class="mb-0 text-muted">
                <span class="fw-bold">ID:</span> @Model.TDR.TDRID |
                <span class="fw-bold">Tipo:</span> @Model.TDR.TDRTypeName |
                <span class="fw-bold">Estado:</span>
                @{
                    string badgeClass = "bg-secondary";

                    switch (Model.TDR.CurrentStateID)
                    {
                        case 1: // Borrador
                            badgeClass = "bg-info";
                            break;
                        case 2: // Pendiente de Revisión
                        case 4: // Pendiente de Revisión Corregida
                            badgeClass = "bg-warning text-dark";
                            break;
                        case 3: // Observado
                            badgeClass = "bg-danger";
                            break;
                        case 5: // Aprobado
                            badgeClass = "bg-success";
                            break;
                        case 6: // Anulado
                            badgeClass = "bg-dark";
                            break;
                    }
                }
                <span class="badge @badgeClass">@Model.TDR.CurrentStateName</span>
            </p>
        </div>
        <div class="d-flex align-items-center">
            @if (esAprobado)
            {
                <a href="@Url.Action("DescargarPDF", "TerminosReferencia", new { id = Model.TDR.TDRID })" class="btn btn-success me-2">
                    <i class="fas fa-file-pdf me-1"></i> Descargar PDF
                </a>
            }

            <a href="@Url.Action("Index", "TerminosReferencia")" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i> Volver al listado
            </a>
        </div>
    </div>

    <!-- Información de la versión -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 bg-white">
            <h6 class="m-0 font-weight-bold" style="color: #2a3c7d;">Información de la Versión</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <p><strong>Versión:</strong> @version.GetProperty("VersionNumber").GetInt32()</p>
                </div>
                <div class="col-md-3">
                    <p><strong>Estado:</strong> @version.GetProperty("StateName").GetString()</p>
                </div>
                <div class="col-md-3">
                    <p><strong>Creado por:</strong> @version.GetProperty("CreatedByUserName").GetString()</p>
                </div>
                <div class="col-md-3">
                    <p><strong>Fecha creación:</strong> @DateTime.Parse(version.GetProperty("CreatedAt").GetString()).ToString("dd/MM/yyyy HH:mm")</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario principal -->
    <form id="formEditarTDR" method="post" action="@Url.Action("Guardar", "TerminosReferencia", new { id = Model.TDR.TDRID, versionId = version.GetProperty("TDRVersionID").GetInt32() })">
        <!-- Pestañas de navegación -->
        <ul class="nav nav-tabs mb-4" id="tdrTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-info" data-bs-toggle="tab" data-bs-target="#pane-info"
                        type="button" role="tab" aria-controls="pane-info" aria-selected="true"
                        style="color: #2a3c7d;">
                    <i class="fas fa-info-circle me-1"></i> Información General
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-alcances" data-bs-toggle="tab" data-bs-target="#pane-alcances"
                        type="button" role="tab" aria-controls="pane-alcances" aria-selected="false"
                        style="color: #495057;">
                    <i class="fas fa-tasks me-1"></i> Alcances
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-requisitos" data-bs-toggle="tab" data-bs-target="#pane-requisitos"
                        type="button" role="tab" aria-controls="pane-requisitos" aria-selected="false"
                        style="color: #495057;">
                    <i class="fas fa-clipboard-check me-1"></i> Requisitos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-plazos" data-bs-toggle="tab" data-bs-target="#pane-plazos"
                        type="button" role="tab" aria-controls="pane-plazos" aria-selected="false"
                        style="color: #495057;">
                    <i class="fas fa-calendar-alt me-1"></i> Plazos y Entregables
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-condiciones" data-bs-toggle="tab" data-bs-target="#pane-condiciones"
                        type="button" role="tab" aria-controls="pane-condiciones" aria-selected="false"
                        style="color: #495057;">
                    <i class="fas fa-file-contract me-1"></i> Condiciones
                </button>
            </li>
        </ul>

        <!-- Contenido de las pestañas -->
        <div class="tab-content" id="tdrTabsContent">
            <!-- Pestaña Información General -->
            <div class="tab-pane fade show active" id="pane-info" role="tabpanel" aria-labelledby="tab-info">
                @foreach (var fieldElement in fields.EnumerateArray())
                {
                    string fieldName = fieldElement.GetProperty("FieldName").GetString();

                    if (infoGeneralFields.Contains(fieldName))
                    {
                        <div class="card shadow-sm mb-3">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">@fieldElement.GetProperty("Description").GetString() - @fieldName</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Contenido</label>
                                    <div class="border rounded p-3 bg-white">
                                        @Html.Raw(fieldElement.GetProperty("HtmlContent").GetString())
                                    </div>
                                </div>

                                <!-- Campo de observaciones -->
                                <div class="mt-3">
                                    <label class="form-label fw-bold">Observaciones</label>
                                    @if (isAdmin)
                                    {
                                        <textarea class="form-control" name="observations[@fieldName]"
                                                  rows="3" placeholder="Ingrese observaciones (solo visible para administradores)">@fieldElement.GetProperty("comment").GetString()</textarea>
                                    }
                                    else
                                    {
                                        <textarea class="form-control" readonly rows="3">@fieldElement.GetProperty("comment").GetString()</textarea>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>

            <!-- Pestaña Alcances -->
            <div class="tab-pane fade" id="pane-alcances" role="tabpanel" aria-labelledby="tab-alcances">
                @foreach (var fieldElement in fields.EnumerateArray())
                {
                    string fieldName = fieldElement.GetProperty("FieldName").GetString();

                    if (alcancesFields.Contains(fieldName))
                    {
                        <div class="card shadow-sm mb-3">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">@fieldElement.GetProperty("Description").GetString() - @fieldName</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Contenido</label>
                                    <div class="border rounded p-3 bg-white">
                                        @Html.Raw(fieldElement.GetProperty("HtmlContent").GetString())
                                    </div>
                                </div>

                                <!-- Campo de observaciones -->
                                <div class="mt-3">
                                    <label class="form-label fw-bold">Observaciones</label>
                                    @if (isAdmin)
                                    {
                                        <textarea class="form-control" name="observations[@fieldName]"
                                                  rows="3" placeholder="Ingrese observaciones (solo visible para administradores)">@fieldElement.GetProperty("comment").GetString()</textarea>
                                    }
                                    else
                                    {
                                        <textarea class="form-control" readonly rows="3">@fieldElement.GetProperty("comment").GetString()</textarea>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>

            <!-- Pestaña Requisitos -->
            <div class="tab-pane fade" id="pane-requisitos" role="tabpanel" aria-labelledby="tab-requisitos">
                @foreach (var fieldElement in fields.EnumerateArray())
                {
                    string fieldName = fieldElement.GetProperty("FieldName").GetString();

                    if (requisitosFields.Contains(fieldName))
                    {
                        <div class="card shadow-sm mb-3">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">@fieldElement.GetProperty("Description").GetString() - @fieldName</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Contenido</label>
                                    <div class="border rounded p-3 bg-white">
                                        @Html.Raw(fieldElement.GetProperty("HtmlContent").GetString())
                                    </div>
                                </div>

                                <!-- Campo de observaciones -->
                                <div class="mt-3">
                                    <label class="form-label fw-bold">Observaciones</label>
                                    @if (isAdmin)
                                    {
                                        <textarea class="form-control" name="observations[@fieldName]"
                                                  rows="3" placeholder="Ingrese observaciones (solo visible para administradores)">@fieldElement.GetProperty("comment").GetString()</textarea>
                                    }
                                    else
                                    {
                                        <textarea class="form-control" readonly rows="3">@fieldElement.GetProperty("comment").GetString()</textarea>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>

            <!-- Pestaña Plazos y Entregables -->
            <div class="tab-pane fade" id="pane-plazos" role="tabpanel" aria-labelledby="tab-plazos">
                @foreach (var fieldElement in fields.EnumerateArray())
                {
                    string fieldName = fieldElement.GetProperty("FieldName").GetString();

                    if (plazosFields.Contains(fieldName))
                    {
                        <div class="card shadow-sm mb-3">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">@fieldElement.GetProperty("Description").GetString() - @fieldName</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Contenido</label>
                                    <div class="border rounded p-3 bg-white">
                                        @Html.Raw(fieldElement.GetProperty("HtmlContent").GetString())
                                    </div>
                                </div>

                                <!-- Campo de observaciones -->
                                <div class="mt-3">
                                    <label class="form-label fw-bold">Observaciones</label>
                                    @if (isAdmin)
                                    {
                                        <textarea class="form-control" name="observations[@fieldName]"
                                                  rows="3" placeholder="Ingrese observaciones (solo visible para administradores)">@fieldElement.GetProperty("comment").GetString()</textarea>
                                    }
                                    else
                                    {
                                        <textarea class="form-control" readonly rows="3">@fieldElement.GetProperty("comment").GetString()</textarea>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>

            <!-- Pestaña Condiciones -->
            <div class="tab-pane fade" id="pane-condiciones" role="tabpanel" aria-labelledby="tab-condiciones">
                @foreach (var fieldElement in fields.EnumerateArray())
                {
                    string fieldName = fieldElement.GetProperty("FieldName").GetString();

                    if (condicionesFields.Contains(fieldName))
                    {
                        <div class="card shadow-sm mb-3">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">@fieldElement.GetProperty("Description").GetString() - @fieldName</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Contenido</label>
                                    <div class="border rounded p-3 bg-white">
                                        @Html.Raw(fieldElement.GetProperty("HtmlContent").GetString())
                                    </div>
                                </div>

                                <!-- Campo de observaciones -->
                                <div class="mt-3">
                                    <label class="form-label fw-bold">Observaciones</label>
                                    @if (isAdmin)
                                    {
                                        <textarea class="form-control" name="observations[@fieldName]"
                                                  rows="3" placeholder="Ingrese observaciones (solo visible para administradores)">@fieldElement.GetProperty("comment").GetString()</textarea>
                                    }
                                    else
                                    {
                                        <textarea class="form-control" readonly rows="3">@fieldElement.GetProperty("comment").GetString()</textarea>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>

        <!-- Botones de acción -->
        <div class="d-flex justify-content-between mt-4 mb-5">
            <button type="button" class="btn btn-outline-secondary" onclick="location.href='@Url.Action("Index", "TerminosReferencia")'">
                <i class="fas fa-times me-1"></i> Cancelar
            </button>

            <button type="button" class="btn btn-primary" id="btnGuardar" style="background-color: #2a3c7d; border-color: #2a3c7d;" disabled>
                <i class="fas fa-save me-1"></i> Guardar Cambios
            </button>
        </div>
    </form>
</div>

<style>
    .nav-tabs .nav-link {
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
    }

        .nav-tabs .nav-link.active {
            border-color: #dee2e6 #dee2e6 #fff;
            font-weight: 600;
        }

    .card-header h5 {
        margin-bottom: 0;
        font-size: 1.1rem;
    }

    .badge {
        font-size: 0.8rem;
        padding: 0.35em 0.65em;
    }
</style>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Colorear las pestañas al hacer clic
            $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                // Quitar el color azul de todas las pestañas
                $('button[data-bs-toggle="tab"]').css('color', '#495057');
                // Aplicar color azul a la pestaña activa
                $(this).css('color', '#2a3c7d');
            });
        });

        function cargarDatosCampos() {
            console.log("Cargando datos de los campos...");

            $.ajax({
                url: '@Url.Action("ObtenerCampos", "TerminosReferencia", new { id = Model.TDR.TDRID, versionId = Model.VersionActual })', // Para opción 1
                // url: '@Url.Action("ObtenerCampos", "TerminosReferencia", new { id = Model.TDRID, versionId = ViewBag.VersionActual })', // Para opción 2
                type: 'GET',
                success: function (data) {
                    console.log("Datos recibidos:", data);
                    // Resto del código...
                },
                error: function (xhr, status, error) {
                    console.error("Error al cargar datos:", error);
                    alert("Error al cargar los datos. Por favor, intente nuevamente.");
                }
            });
        }
    </script>
}